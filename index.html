<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Card Printing System</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --scale: 1;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }

    body {
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }

    .input-section {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    .input-section h2 {
      margin-bottom: 10px;
      color: #555;
    }

    .input-options {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .input-options button {
      padding: 8px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .input-options button:hover {
      background-color: #45a049;
    }

    textarea {
      width: 100%;
      height: 150px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: vertical;
    }

    .file-input {
      margin-top: 10px;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
    }

    .controls button {
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }

    #addBtn { background-color: #2196F3; color: white; }
    #addBtn:hover { background-color: #0b7dda; }

    #mergeBtn { background-color: #FF9800; color: white; }
    #mergeBtn:hover { background-color: #e68a00; }

    #downloadBtn { background-color: #4CAF50; color: white; }
    #downloadBtn:hover { background-color: #45a049; }

    #printBtn { background-color: #9C27B0; color: white; }
    #printBtn:hover { background-color: #7b1fa2; }

    .layout-selector {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
    }

    select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .preview-section {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    .flexy {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      width: 70%;
    }

    .page {
      width: 210mm;
      height: 297mm;
      margin: 0 auto 20px;
      padding: 5mm;
      background-color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      page-break-after: always;
      position: relative;
      overflow: hidden;
    }

    .page.landscape {
      width: 297mm;
      height: 210mm;
    }

    .card-grid {
      display: grid;
      width: 100%;
      height: 100%;
      gap: 2mm;
    }

    .card {
      border: 1px solid #ddd;
      padding: calc(2mm * var(--scale));
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
      font-size: calc(9px * var(--scale));
      background: white;
      overflow: hidden;
    }

    /* Base card content styles (applied to all layouts unless overridden) */
    .card-content {
      display: flex;
      flex-direction: column;
      height: 100%;
      justify-content: space-between;
    }

    .card-logo { 
      width: calc(30px * var(--scale)); 
      height: calc(30px * var(--scale)); 
      object-fit: contain;
      flex-shrink: 0;
    }
    
    .card-amount { 
      font-weight: bold; 
      font-size: calc(12px * var(--scale)); 
      margin-bottom: calc(0.5mm * var(--scale)); 
    }
    
    .card-ref { 
      font-size: calc(10px * var(--scale)); 
      margin-bottom: calc(0.5mm * var(--scale)); 
    }
    
    .jbonly { font-weight: bold; }
    
    .card-serial { 
      font-family: 'Times New Roman'; 
      font-size: calc(11px * var(--scale)); 
      margin: 0;
    }
    
    .card-pin { 
      font-family: 'Times New Roman'; 
      font-size: calc(14px * var(--scale)); 
      margin: 0;
    }
    
    .pinonly { font-weight: bold; }
    
    .card-date { 
      font-size: calc(9px * var(--scale)); 
      color: #666; 
      margin: 0;
    }

    .topit {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: nowrap;
    }

    .topit-content {
      flex: 1;
      margin-right: calc(2mm * var(--scale));
    }

    /* Layout-specific card classes for future customization */
    /* Add your custom styles here for each layout. For example: */
    /* .card-4x10 .card-content { flex-direction: row; } */
    /* .card-4x10 .card-amount { color: red; font-size: larger; } */

    /* 4x10 Layout (Landscape) */
    .card-4x10 .card-content { /* Customize content layout, fonts, colors, etc. */ }
    .card-4x10 .card-amount { /* e.g., .card-amount { background: blue; } */ }
    .card-4x10 .card-ref { /* Add layout-specific tweaks */ }
    .card-4x10 .card-serial { /* ... */ }
    .card-4x10 .card-pin { /* ... */ }
    .card-4x10 .card-date { /* ... */ }
    .card-4x10 .topit { /* ... */ }
    .card-4x10 .card-logo { /* e.g., .card-logo { width: 40px; } */ }

    /* 5x10 Layout (Landscape) */
    .card-5x10 .card-content { /* Customize content layout, fonts, colors, etc. */ }
    .card-5x10 .card-amount { /* e.g., .card-amount { background: green; } */ }
    .card-5x10 .card-ref { /* Add layout-specific tweaks */ }
    .card-5x10 .card-serial { /* ... */ }
    .card-5x10 .card-pin { /* ... */ }
    .card-5x10 .card-date { /* ... */ }
    .card-5x10 .topit { /* ... */ }
    .card-5x10 .card-logo { /* e.g., .card-logo { height: 35px; } */ }

    /* 6x10 Layout (Landscape) */
    .card-6x10 .card-content { /* Customize content layout, fonts, colors, etc. */ }
    .card-6x10 .card-amount { /* e.g., .card-amount { font-style: italic; } */ }
    .card-6x10 .card-ref { /* Add layout-specific tweaks */ }
    .card-6x10 .card-serial { /* ... */ }
    .card-6x10 .card-pin { /* ... */ }
    .card-6x10 .card-date { /* ... */ }
    .card-6x10 .topit { /* ... */ }
    .card-6x10 .card-logo { /* ... */ }

    /* 10x4 Layout (Portrait) */
    .card-10x4 .card-content { /* Customize content layout, fonts, colors, etc. */ }
    .card-10x4 .card-amount { /* e.g., .card-amount { text-align: center; } */ }
    .card-10x4 .card-ref { /* Add layout-specific tweaks */ }
    .card-10x4 .card-serial { /* ... */ }
    .card-10x4 .card-pin { font-size: calc(13px * var(--scale));  }
    .card-10x4 .card-date { /* ... */ }
    .card-10x4 .topit { /* ... */ }
    .card-10x4 .card-logo { /* ... */ }

    /* 15x4 Layout (Portrait) */
    .card-15x4 .card-content { /* Customize content layout, fonts, colors, etc. */ }
    .card-15x4 .card-amount { /* e.g., .card-amount { padding: 2px; } */ }
    .card-15x4 .card-ref { /* Add layout-specific tweaks */ }
    .card-15x4 .card-serial { /* ... */ }
    .card-15x4 .card-pin { /* ... */ }
    .card-15x4 .card-date { /* ... */ }
    .card-15x4 .topit { /* ... */ }
    .card-15x4 .card-logo { /* ... */ }

    /* 12x4 Layout (Portrait) */
    .card-12x4 .card-content { /* Customize content layout, fonts, colors, etc. */ }
    .card-12x4 .card-amount { /* e.g., .card-amount { border-bottom: 1px solid; } */ }
    .card-12x4 .card-ref { /* Add layout-specific tweaks */ }
    .card-12x4 .card-serial { /* ... */ }
    .card-12x4 .card-pin { /* ... */ }
    .card-12x4 .card-date { /* ... */ }
    .card-12x4 .topit { /* ... */ }
    .card-12x4 .card-logo { /* ... */ }

    /* 10x3 Layout (Portrait) */
    .card-10x3 .card-content { /* Customize content layout, fonts, colors, etc. */ }
    .card-10x3 .card-amount { /* e.g., .card-amount { color: purple; } */ }
    .card-10x3 .card-ref { /* Add layout-specific tweaks */ }
    .card-10x3 .card-serial { /* ... */ }
    .card-10x3 .card-pin { /* ... */ }
    .card-10x3 .card-date { /* ... */ }
    .card-10x3 .topit { /* ... */ }
    .card-10x3 .card-logo { /* ... */ }

    /* 10x2 Layout (Portrait) */
    .card-10x2 .card-content { /* Customize content layout, fonts, colors, etc. */ }
    .card-10x2 .card-amount { /* e.g., .card-amount { font-size: smaller; } */ }
    .card-10x2 .card-ref { /* Add layout-specific tweaks */ }
    .card-10x2 .card-serial { /* ... */ }
    .card-10x2 .card-pin { /* ... */ }
    .card-10x2 .card-date { /* ... */ }
    .card-10x2 .topit { /* ... */ }
    .card-10x2 .card-logo { /* ... */ }

    .no-preview {
      text-align: center;
      padding: 20px;
      color: #888;
      font-style: italic;
    }

    .page-count { color: #555; font-size: 14px; }

    @media print {
      @page { 
        size: A4; 
        margin: 0; 
      }
      @page landscape {
        size: landscape;
      }
      body { 
        background-color: white; 
        padding: 0; 
        margin: 0; 
      }
      .container { 
        box-shadow: none; 
        padding: 0; 
        margin: 0; 
        width: 210mm; 
        height: 297mm; 
      }
      .container h1, .input-section, .controls, .layout-selector, .preview-section .flexy, .page-count { 
        display: none; 
      }
      .page { 
        box-shadow: none; 
        margin: 0; 
        padding: 5mm; 
        width: 210mm; 
        height: 297mm; 
        page-break-after: always; 
      }
      .page.landscape { 
        width: 297mm; 
        height: 210mm; 
      }
      .preview-section { 
        margin: 0; 
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Card Printing System</h1>
    <h2 style="text-align: center;">J&amp;B Concepts</h2>
    <div class="input-section">
      <h2>Input Card Data</h2>
      <div class="input-options">
        <button id="pasteBtn">Paste Text</button>
        <input type="file" id="fileInput" class="file-input" accept=".txt">
      </div>
      <textarea id="textInput" placeholder="Paste your card data here or upload a .txt file"></textarea>
    </div>

    <div class="controls">
      <button id="addBtn">Add Cards</button>
      <button id="mergeBtn">Merge Cards</button>
      <button id="downloadBtn">Download PDF</button>
    </div>

    <div class="layout-selector">
      <label for="layoutSelect">Layout:</label>
      <select id="layoutSelect">
        <option value="4x10">4x10 (40 cards per page - Landscape)</option>
        <option value="5x10">5x10 (50 cards per page - Landscape)</option>
        <option value="6x10">6x10 (60 cards per page - Landscape)</option>
        <option value="10x4">10x4 (40 cards per page - Portrait)</option>
        <option value="15x4">15x4 (60 cards per page - Portrait)</option>
        <option value="12x4">12x4 (48 cards per page - Portrait)</option>
        <option value="10x3">10x3 (30 cards per page - Portrait)</option>
        <option value="10x2">10x2 (20 cards per page - Portrait)</option>
      </select>
    </div>

    <div class="preview-section">
      <div class="flexy">
        <h2>Preview</h2>
        <span class="page-count" id="pageCount"></span>
      </div>
      <div id="previewContainer">
        <div class="no-preview">No cards added yet. Add cards to see preview.</div>
      </div>
    </div>
  </div>

  <script>
    let allCards = [];
    const networkLogos = {
      'MTN': 'mtn.png','AIRTEL': 'airtel.png','GLO': 'glo.png','9MOBILE': '9mobile.png',
      'Mtn': 'mtn.png','Airtel': 'airtel.png','Glo': 'glo.png','9mobile': '9mobile.png'
    };

    const textInput = document.getElementById('textInput');
    const fileInput = document.getElementById('fileInput');
    const pasteBtn = document.getElementById('pasteBtn');
    const addBtn = document.getElementById('addBtn');
    const mergeBtn = document.getElementById('mergeBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const printBtn = document.getElementById('printBtn');
    const layoutSelect = document.getElementById('layoutSelect');
    const previewContainer = document.getElementById('previewContainer');
    const pageCountElement = document.getElementById('pageCount');

    pasteBtn.addEventListener('click', () => {
      navigator.clipboard.readText().then(text => textInput.value = text);
    });
    
    fileInput.addEventListener('change', e => {
      const file = e.target.files[0]; 
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => textInput.value = e.target.result;
      reader.readAsText(file);
    });

    function parseCardData(text) {
      const lines = text.split('\n'), cards = [];
      for (const line of lines) {
        if (!line.trim() || line.includes('Serial') || line.includes('Pin')) continue;
        const parts = line.trim().split(/\s+/);
        if (parts.length >= 5 && /^\d{14,}/.test(parts[0]) && /^\d{5,}/.test(parts[1])) {
          cards.push({
            serial: parts[0],
            pin: parts[1],
            network: parts[2],
            amount: parts[3],
            date: parts.slice(4).join(' ')
          });
        } else if (parts.length >= 6 && /^\d+$/.test(parts[0]) && parts[2].startsWith('@')) {
          cards.push({
            index: parts[0],
            date: parts[1] + " " + parts[2],
            network: parts[3],
            amount: parts[4],
            serial: parts[5],
            pin: parts[6]
          });
        }
      }
      return cards;
    }

    addBtn.addEventListener('click', () => {
      const newCards = parseCardData(textInput.value.trim());
      allCards = newCards;
      textInput.value = ''; 
      fileInput.value = '';
      renderPreview();
    });

    mergeBtn.addEventListener('click', () => {
      const newCards = parseCardData(textInput.value.trim());
      allCards = [...allCards, ...newCards];
      textInput.value = ''; 
      fileInput.value = '';
      renderPreview();
    });

    layoutSelect.addEventListener('change', renderPreview);

    function renderPreview() {
      if (allCards.length === 0) {
        previewContainer.innerHTML = '<div class="no-preview">No cards added yet.</div>';
        pageCountElement.textContent = ''; 
        return;
      }
      
      const layout = layoutSelect.value;
      const isLandscape = ['4x10', '5x10', '6x10'].includes(layout);
      
      let rows, cols;
      if (isLandscape) {
        // For landscape: layout is cols x rows
        [cols, rows] = layout.split('x').map(Number);
      } else {
        // For portrait: layout is rows x cols  
        [rows, cols] = layout.split('x').map(Number);
      }

      const cardsPerPage = rows * cols;
      const pageCount = Math.ceil(allCards.length / cardsPerPage);
      pageCountElement.textContent = `(${pageCount} page${pageCount > 1 ? 's' : ''})`;
      
      // Calculate scale based on layout
      let scale;
      if (isLandscape) {
        // For landscape layouts, calculate based on both width and height
        const page_inner_w_mm = 297 - 10; // Landscape width minus padding
        const page_inner_h_mm = 210 - 10; // Landscape height minus padding
        
        const gap_mm = 2;
        const gaps_w_mm = (cols - 1) * gap_mm;
        const gaps_h_mm = (rows - 1) * gap_mm;
        
        const col_w_mm = (page_inner_w_mm - gaps_w_mm) / cols;
        const row_h_mm = (page_inner_h_mm - gaps_h_mm) / rows;
        
        // Base measurements for reference
        const base_card_w_mm = 20;
        const base_card_h_mm = 28;
        
        // Calculate scale based on both dimensions and use the smaller one
        const w_scale = col_w_mm / base_card_w_mm;
        const h_scale = row_h_mm / base_card_h_mm;
        scale = Math.min(w_scale, h_scale);
      } else {
        // For portrait layouts, calculate based on cell height
        const page_inner_h_mm = 297 - 10; // A4 height minus 5mm padding on top and bottom
        const gap_mm = 2;
        const gaps_h_mm = (rows - 1) * gap_mm;
        const row_h_mm = (page_inner_h_mm - gaps_h_mm) / rows;
        const card_padding_v_mm = 4; // 2mm padding top + bottom

        // Base measurements for 10 rows
        const base_rows = 10;
        const base_gaps_h_mm = (base_rows - 1) * gap_mm;
        const base_row_h_mm = (page_inner_h_mm - base_gaps_h_mm) / base_rows;
        const base_card_padding_v_mm = 4;
        const base_inner_h_mm = base_row_h_mm - base_card_padding_v_mm;

        // Calculate scale to maximize content size
        const inner_h_mm = row_h_mm - card_padding_v_mm;
        scale = inner_h_mm / base_inner_h_mm;
      }
      
      // Cap scale to prevent overflow and ensure readability
      scale = Math.min(1.2, Math.max(0.8, scale));
      document.documentElement.style.setProperty('--scale', scale);

      previewContainer.innerHTML = '';
      for (let i = 0; i < allCards.length; i += cardsPerPage) {
        createPage(allCards.slice(i, i + cardsPerPage), rows, cols, i, isLandscape, layout);
      }
    }

    function createPage(cards, rows, cols, startIndex, isLandscape, layout) {
      const page = document.createElement('div');
      page.className = isLandscape ? 'page landscape' : 'page';
      const grid = document.createElement('div');
      grid.className = 'card-grid';
      grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
      grid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
      cards.forEach((c, idx) => grid.appendChild(createCardElement(c, startIndex + idx + 1, layout)));
      page.appendChild(grid); 
      previewContainer.appendChild(page);
    }


    function formatPinSmart(pin) {
      const groups = [];
      let i = 0;

      // While we still have enough digits for a full group of 4
      while (pin.length - i > 4) {
        groups.push(pin.slice(i, i + 4));
        i += 4;
      }

      // Push the remainder (whatever is left, even if < 4) into the last group
      groups.push(pin.slice(i));

      // If the last group is shorter, merge it with the previous one
      if (groups.length > 1 && groups[groups.length - 1].length < 4) {
        groups[groups.length - 2] += groups.pop();
      }

      return groups.join("-");
    }

    function createCardElement(card, cellNumber, layout) {
      const div = document.createElement('div');
      div.className = `card card-${layout}`;

      const formattedPin = formatPinSmart(card.pin);

      div.innerHTML = `
        <div class="card-content">
          <div class="topit">
            <div class="topit-content">
              <div class="card-amount">${card.network} ${card.amount}</div>
              <div class="card-ref">Ref: <span class="jbonly">J&B Concepts_${cellNumber}</span></div>
              <div class="card-serial">S/N: ${card.serial}</div>
            </div>
            <img class="card-logo" src="${networkLogos[card.network] || 'default.png'}" alt="${card.network}">
          </div>
          <div class="card-pin">PIN: <span class="pinonly">${formattedPin}</span></div>
          <div class="card-date">${card.date}</div>
        </div>`;
      return div;
    }


    downloadBtn.addEventListener('click', () => {
      if (!allCards.length) return alert('No cards to download.');
      const { jsPDF } = window.jspdf; 
      
      const pages = document.querySelectorAll('.page');
      let doc = null;
      
      const capturePage = idx => {
        if (idx >= pages.length) return doc.save('cards.pdf');
        const page = pages[idx];
        const isLandscape = page.classList.contains('landscape');
        
        // Create PDF with correct orientation for the first page
        if (idx === 0) {
          doc = new jsPDF({ 
            orientation: isLandscape ? 'landscape' : 'portrait', 
            unit: 'mm', 
            format: 'a4' 
          });
        }
        
        html2canvas(page, { scale: 2, useCORS: true }).then(canvas => {
          if (idx > 0) {
            doc.addPage([210, 297], isLandscape ? 'landscape' : 'portrait');
          }
          const imgWidth = isLandscape ? 297 : 210;
          const imgHeight = isLandscape ? 210 : 297;
          doc.addImage(canvas.toDataURL('image/jpeg', 1.0), 'JPEG', 0, 0, imgWidth, imgHeight);
          capturePage(idx + 1);
        });
      };
      capturePage(0);
    });


  </script>
</body>
</html>